# This workflow will build a package using Maven and then publish it to GitHub packages when a release is created
# For more information see: https://o00o.us.to/actions/setup-java#apache-maven-with-a-settings-path

name: CreateIssue

on:
   schedule: 
       - cron: '1 0 1,16 * *'
   label:
       types: [edited]
jobs:
  build:

    runs-on: ubuntu-latest
       
    steps:
    - uses: actions/checkout@v4
           
    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: 3.13
        
    - name: Generate github hosts
      run: |
        python socket_query.py
        cat hosts.txt
 
    
    - name: Close issues of hosts label, return 'invalid' if latest action runs within an hour
      uses: actions/github-script@0.4.0
      id: check
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        result-encoding: string
        script: |
            let response = await github.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['host'],
                state: 'open'
            });
            let data = response['data'];

            try {
                data.forEach(function (issue) {
                    let id = issue['number'];
                    let updated_at = new Date(issue['updated_at']);
                    let time_now = new Date();
                    let deta = time_now.getTime() - updated_at.getTime();
                    console.log('deta: ' + deta);
                    if (deta < 1000 * 60 * 60) {
                        throw new Error("latest action runs within an hour");
                    }
                    github.issues.update({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: id,
                        state: 'closed'
                    });
                });
                return 'valid';
            } catch (e) {
                return 'invalid';
            }
    - name: Close issues of out-dated host query
      uses: actions/github-script@0.4.0
      if: ${{ steps.check.outputs.result == 'valid'}}
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
            let response = await github.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['host-query'],
                state: 'open',
                sort: 'updated',
                direction: 'asc'
            });
            let data = response['data'];

            data.forEach(function (issue) {
                let id = issue['number'];
                let is2Deal = true;
                let updated_at = new Date(issue['updated_at']);
                let time_now = new Date();
                let deta = time_now.getTime() - updated_at.getTime();
                console.log('deta: ' + deta);
                if (deta < 1000 * 60 * 60 * 24 * 5) {
                    is2Deal = false;
                }
                if (is2Deal) {
                    github.issues.update({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: id,
                        state: 'closed'
                    });
                }
            });
    - name: Create and lock issue to show hosts
      uses: actions/github-script@0.4.0
      if: ${{ steps.check.outputs.result == 'valid'}}
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
            const date = new Date();
            const year = date.getFullYear().toString();
            const month = (date.getMonth() + 1).toString();
            const day = date.getDate().toString();
            const title = year + '-' + month + '-' + day + ' github hosts';
            var fs = require("fs");
            fs.readFile("hosts.txt", 'utf-8', (err, data) => {
                github.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    labels: ['host'],
                    title: title,
                    body: data
                }).then((res) =>{
                    github.issues.lock({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: res.data.number,
                        lock_reason: "off-topic",
                    });
                });
            });

    


